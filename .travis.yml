# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

os: linux
dist: focal
arch: arm64
#arch: arm64-graviton2
#group: edge
#virt: vm
language: generic
sudo: false

before_cache:
  - sudo chown -R travis:travis $HOME/.m2
  # Ensure that jobs do not influence each other with installed Zeppelin Jars
  - rm -rf $HOME/.m2/repository/org/apache/avro/

cache:
  apt: true
  directories:
    - ${HOME}/.m2

matrix:
  include:
    - name: Java
      addons:
        apt:
          update: true
          packages:
            - openjdk-8-jdk
            - wget
      install:
        - export MAVEN_VERSION="3.8.3"
        - wget https://dlcdn.apache.org/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz
        - tar zxvf apache-maven-$MAVEN_VERSION-bin.tar.gz
        - export M2_HOME=$PWD/apache-maven-$MAVEN_VERSION
        - export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-arm64"
        - export PATH="$M2_HOME/bin:$JAVA_HOME/bin:$PATH"
      before_script:
        - java -version
        - mvn -version
      script:
        - cd lang/java
        - ./build.sh clean test

    - name: C
      addons:
        apt:
          update: true
          packages:
            - libjansson-dev
            - liblzma-dev
            - libsnappy-dev
      script:
        - cd lang/c
        - ./build.sh clean test

    - name: C++
      addons:
        apt:
          update: true
          packages:
            - cmake
            - libboost-all-dev
      script:
        - cd lang/c++
        - ./build.sh clean test

    - name: C#
      addons:
        apt:
          update: true
          packages:
            - wget
      install:
        - wget https://dot.net/v1/dotnet-install.sh
        - bash dotnet-install.sh --channel Current
      before_script:
        - export PATH=$HOME/.dotnet:$PATH
        - dotnet --list-sdks
      script:
        - cd lang/csharp
        - ./build.sh clean test

    - name: Python
      addons:
        apt:
          update: true
          packages:
            - python3-pip
      install:
        - pip install tox
      script:
        - cd lang/py
        - ./build.sh clean test

    - name: Ruby
      script:
        - cd lang/ruby
        - ./build.sh clean test

    - name: Rust
      addons:
        apt:
          update: true
          packages:
            - cargo
      script:
        - cd lang/rust
        - ./build.sh clean test

    - name: Perl
      script:
        - cd lang/perl
        - ./build.sh clean test

    - name: PHP
      addons:
        apt:
          update: true
          packages:
            - wget
            - php
            - php-xml
            - php-mbstring
            - php-curl
            - php-gmp
            - php-bz2
            - unzip
      install:
        - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        - php -r "if (hash_file('sha384', 'composer-setup.php') === '906a84df04cea2aa72f40b5f787e49f22d4c2f19492ac310e8cba5b96ac8b64115ac402c8cd292b8a03482574915d1a8') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
        - php composer-setup.php
        - php -r "unlink('composer-setup.php');"
        - sudo mv composer.phar /usr/local/bin/composer
      script:
        - cd lang/php
        - ./build.sh clean test

before_install:
  - lscpu
